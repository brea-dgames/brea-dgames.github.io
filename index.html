<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bread-Games</title>
    <link rel="icon" type="image/x-icon" href="https://document-export.canva.com/cVnEI/DAG6prcVnEI/4/thumbnail/0001.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAQYCGKMUHWEOTUD6Q%2F20251205%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20251205T163956Z&X-Amz-Expires=23613&X-Amz-Signature=080e917ff154301333b4d4a294fa4ae492513bc1613cfe155af5362980ddf56b&X-Amz-SignedHeaders=host&response-expires=Fri%2C%2005%20Dec%202025%2023%3A13%3A29%20GMT">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        .text-outline {
            text-shadow: -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000;
        }
        .text-gold { color: #796833; }
        .text-red-outline {
            text-shadow: -0.5px -0.5px 0 #c25252, 0.5px -0.5px 0 #c25252, -0.5px 0.5px 0 #c25252, 0.5px 0.5px 0 #c25252;
            color: #eb1818;
        }
        #game-frame-container, #settings-page, #ai-modal {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0,0,0,0.95); z-index:100;
            display: none; flex-direction: column; align-items:center; justify-content:center; overflow-y:auto;
        }
        #settings-page, #ai-modal { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(10px); }
        #game-frame { width:100%; height:100%; border:none; background-color:#fff; }
        .Header { text-align:center; }
        #drawing-canvas { touch-action:none; background-color:white; border:4px solid #796833; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.1); }
        .tag-pill { font-size: 10px; padding: 2px 6px; border-radius: 9999px; font-weight: bold; background: #f3f4f6; color: #4b5563; }
        .game-card:hover { transform: translateY(-4px); transition: transform 0.2s ease; }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#d3c865] min-h-screen p-4 md:p-8">

    <header id="main-header" class="Header bg-[#f4e1a1] p-6 rounded-xl shadow-2xl mb-8">
        <h1 class="text-5xl font-extrabold text-[#fffff0] text-outline mb-2">Bread-Games</h1>
        <h3 id="author-text" class="text-xl font-semibold text-gold mb-4">Created by Ethan Taylor</h3>
        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <a href="https://youtube.com/@cocacolaplayz" class="text-lg font-bold text-red-outline transition duration-300 hover:scale-105 inline-block">
                Owner's Social Media
            </a>
            <button id="open-settings-btn" class="text-lg font-bold text-blue-700 bg-white/50 px-4 py-1 rounded-full hover:bg-white transition duration-300 inline-block shadow-sm">
                ‚öôÔ∏è Settings & Account
            </button>
        </div>

        <div id="user-system-container" class="max-w-4xl mx-auto p-4 bg-yellow-100 rounded-xl shadow-inner border-2 border-yellow-300 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center space-x-4">
                <canvas id="display-avatar" width="64" height="64" class="w-16 h-16 rounded-full border-4 border-yellow-500 bg-white shadow-lg"></canvas>
                <div class="text-left">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">üçû Player Profile</h2>
                    <p class="text-gray-700 text-lg">User: <span id="display-username" class="font-extrabold text-blue-600">Guest</span></p>
                </div>
            </div>

            <div class="flex-1 flex gap-4 w-full md:w-auto">
                <div class="flex-1 bg-white p-3 rounded-lg shadow-inner border border-gray-200">
                    <h2 class="text-sm font-bold text-gray-800 uppercase tracking-tighter mb-1">üìä Stats</h2>
                    <div id="stats-panel" class="text-xs text-gray-700 grid grid-cols-2 gap-x-2">
                        Loading...
                    </div>
                </div>
                <div class="flex-1 bg-white p-3 rounded-lg shadow-inner border border-gray-200">
                    <h2 class="text-sm font-bold text-gray-800 uppercase tracking-tighter mb-1">üèÜ Achievements</h2>
                    <div id="achievements-panel" class="flex flex-wrap gap-1">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="Content max-w-6xl mx-auto">
        <div class="bg-white/40 backdrop-blur-md p-4 rounded-xl mb-8 flex flex-col md:flex-row justify-between items-center gap-4 shadow-lg">
            <div class="relative w-full md:w-1/2">
                <input type="text" id="search-input" placeholder="Search games..." class="w-full p-2 pl-10 rounded-lg border-2 border-yellow-400 focus:outline-none focus:border-yellow-600 transition">
                <span class="absolute left-3 top-2.5 opacity-50">üîç</span>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <span class="text-sm font-bold text-gray-600">Filter:</span>
                <select id="filter-tag-select" class="p-2 border-2 border-yellow-400 rounded-lg bg-white text-sm font-semibold flex-1 md:flex-none">
                    <option value="All">All Categories</option>
                    <option value="Action">Action</option>
                    <option value="Puzzle">Puzzle</option>
                    <option value="Bread-Themed">Bread-Themed</option>
                    <option value="Arcade">Arcade</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        
        <p id="no-games-message" class="text-lg text-center font-bold text-gray-700 hidden mb-8">No games found.</p>
        <div id="game-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12"></div>

        <section id="game-editor-section" class="mt-12 p-6 md:p-10 bg-white rounded-xl shadow-2xl scroll-mt-8 border-t-8 border-green-500">
            <div class="flex justify-between items-center mb-6">
                <h2 id="studio-heading" class="text-4xl font-bold text-gray-800">üïπÔ∏è Bread Game Studio</h2>
                <button id="magic-bake-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full flex items-center gap-2 transition shadow-lg">
                    <span>‚ú® TaylorTech Game Helper</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="game-title-input" class="block text-lg font-semibold text-gray-700 mb-2">Game Title</label>
                    <input type="text" id="game-title-input" placeholder="My Awesome Bread Game" class="w-full p-3 border border-gray-400 rounded-lg text-lg mb-4">
                    
                    <label for="game-tag-input" class="block text-lg font-semibold text-gray-700 mb-2">Game Category</label>
                    <select id="game-tag-input" class="w-full p-3 border border-gray-400 rounded-lg text-lg mb-4">
                        <option value="Other">Other</option>
                        <option value="Action">Action</option>
                        <option value="Puzzle">Puzzle</option>
                        <option value="Bread-Themed">Bread-Themed</option>
                        <option value="Arcade">Arcade</option>
                    </select>

                    <label class="block text-lg font-semibold text-gray-700 mb-2">Thumbnail</label>
                    <div class="flex gap-4 items-center mb-4 p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <div id="thumbnail-preview-container" class="w-16 h-16 border rounded-md overflow-hidden bg-white flex items-center justify-center text-3xl shadow-sm">üçû</div>
                        <div class="flex flex-col gap-2">
                            <input type="file" id="thumbnail-upload" accept="image/*" class="text-xs">
                            <button id="use-avatar-thumbnail-btn" class="bg-yellow-600 text-white text-[10px] font-bold py-1 px-3 rounded uppercase hover:bg-yellow-700">Snapshot Avatar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="game-code-input" class="block text-lg font-semibold text-gray-700 mb-2">Game Code (HTML/JS)</label>
                    <textarea id="game-code-input" class="w-full h-64 p-4 border-2 border-gray-400 rounded-lg text-sm bg-gray-900 text-green-400 font-mono" placeholder="<html>...</html>"></textarea>
                </div>
            </div>

            <div class="mt-8 flex flex-wrap justify-center gap-4">
                <button id="publish-game-btn" class="bg-green-600 text-white font-black py-4 px-10 rounded-xl shadow-lg hover:bg-green-700 transition"> PUBLISH LOCALLY </button>
                <button id="cancel-edit-btn" class="hidden bg-gray-500 text-white font-bold py-4 px-10 rounded-xl shadow-lg hover:bg-gray-600 transition"> CANCEL </button>
                <button id="import-game-btn" class="bg-yellow-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-yellow-700 transition"> IMPORT .BREAD </button>
                <button id="download-game-btn" class="bg-red-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-red-700 transition"> DOWNLOAD .BREAD </button>
            </div>
            <input type="file" id="import-game-file" accept=".bread" class="hidden">
        </section>

        <section class="mt-12 p-6 md:p-10 bg-white rounded-xl shadow-2xl max-w-4xl mx-auto border-t-8 border-blue-500">
            <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center">üé® Avatar Studio</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/4 space-y-4">
                    <input type="color" id="color-picker" value="#000000" class="w-full h-12 rounded-lg cursor-pointer border-2 bg-white p-1">
                    <input type="range" id="size-slider" min="1" max="50" value="5" class="w-full accent-blue-600">
                    <button id="clear-canvas-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-300">Reset</button>
                    <button id="set-avatar-btn" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-700">UPDATE AVATAR</button>
                </div>
                <div class="w-full md:w-3/4 flex justify-center">
                    <canvas id="drawing-canvas" width="300" height="300" class="w-full max-w-[300px] aspect-square"></canvas>
                </div>
            </div>
        </section>
    </main>

    <div id="game-frame-container">
        <div class="w-full bg-black/80 p-2 flex justify-between items-center text-white px-8">
            <span id="playing-title" class="font-bold">Bread Game</span>
            <button id="exit-game-btn" class="bg-red-600 text-white font-black text-xl px-4 py-1 rounded hover:bg-red-700 transition">CLOSE</button>
        </div>
        <iframe id="game-frame"></iframe>
    </div>

    <div id="ai-modal">
        <div class="max-w-lg w-full bg-white rounded-2xl p-8 shadow-2xl border-4 border-purple-500 relative">
            <button id="close-ai-modal" class="absolute top-4 right-4 text-2xl font-bold text-gray-400">&times;</button>
            <h2 id="ai-modal-title" class="text-2xl font-bold mb-4 flex items-center gap-2 text-purple-700">‚ú® TaylorTech Game Helper</h2>
            <div id="ai-modal-content" class="text-gray-700 leading-relaxed max-h-96 overflow-y-auto pr-2">
                Processing...
            </div>
        </div>
    </div>

    <div id="settings-page">
        <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 mt-10 mx-auto border-4 border-yellow-400 relative">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-3xl font-bold text-gray-400 hover:text-red-500">&times;</button>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-8 border-b pb-4">‚öôÔ∏è Account Settings</h2>
            <div class="space-y-6">
                <div class="p-5 bg-blue-50 rounded-xl border-2 border-blue-200">
                    <h3 class="font-bold text-blue-800 mb-3">Display Name</h3>
                    <div class="flex gap-2">
                        <input type="text" id="username-input" placeholder="New Username" class="flex-1 p-2 border rounded-md">
                        <button id="set-username-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-bold">Update</button>
                    </div>
                </div>
                <div class="p-5 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                    <h3 class="font-bold text-indigo-800 mb-3">Backup & Recovery</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="download-user-data-btn" class="bg-indigo-600 text-white font-bold py-2 rounded-md text-sm">Export .BreadACC</button>
                        <button id="import-user-data-btn-trigger" class="bg-white border-2 border-indigo-600 text-indigo-600 font-bold py-2 rounded-md text-sm">Import .BreadACC</button>
                    </div>
                    <input type="file" id="import-user-data-file" accept=".BreadACC" class="hidden">
                </div>
                <div class="p-5 bg-red-50 rounded-xl border-2 border-red-200">
                    <h3 class="font-bold text-red-800 mb-1">Factory Reset</h3>
                    <button id="nuke-data-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md text-sm hover:bg-red-600">Wipe Everything</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const apiKey = "AIzaSyD4iBvhFZSHZC3VRdjiYQT0nh5wkuRixTA";
        let userData = { username: 'Guest' };
        let stats = {};
        let achievements = {};
        let currentThumbnailDataURL = null;
        let activeFilter = 'All';
        let searchQuery = '';
        let editingGameId = null;

        const USERNAME_KEY = 'breadgames_username';
        const STATS_KEY = 'breadgames_stats';
        const ACHIEVEMENTS_KEY = 'breadgames_achievements';
        const PUBLISHED_GAMES_KEY = 'breadgames_published_games';
        const AVATAR_KEY = 'breadgames_avatar_data';

        async function callGemini(prompt, systemPrompt = "You are a helpful assistant.") {
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
            throw new Error("Failed to reach Gemini after retries.");
        }

        function loadUserData() {
            userData.username = localStorage.getItem(USERNAME_KEY) || 'Guest';
            updateDisplay();
            loadAvatar();
        }

        function saveUserData() {
            localStorage.setItem(USERNAME_KEY, userData.username);
            updateDisplay();
            renderGameList();
        }

        function updateDisplay() {
            document.getElementById('display-username').textContent = userData.username;
        }

        function renderStatsPanel() {
            const el = document.getElementById('stats-panel');
            el.innerHTML = `
                <div>Created: <strong>${stats.gamesCreated || 0}</strong></div>
                <div>Played: <strong>${stats.gamesPlayed || 0}</strong></div>
                <div>Avatars: <strong>${stats.avatarsMade || 0}</strong></div>
                <div>Visits: <strong>${stats.timesVisitedStudio || 0}</strong></div>
            `;
        }

        function renderAchievementsPanel() {
            const el = document.getElementById('achievements-panel');
            el.innerHTML = '';
            const list = [
                { key: 'firstGamePublished', sym: 'üéÆ' },
                { key: 'firstAvatarDrawn', sym: 'üé®' },
                { key: 'played5Games', sym: 'üî•' },
                { key: 'magicBakerUsed', sym: '‚ú®' }
            ];
            list.forEach(item => {
                if (achievements[item.key]) {
                    const span = document.createElement('span');
                    span.className = "text-xl grayscale-0";
                    span.title = item.key;
                    span.textContent = item.sym;
                    el.appendChild(span);
                }
            });
        }

        function saveStats() {
            localStorage.setItem(STATS_KEY, JSON.stringify(stats));
            renderStatsPanel();
        }

        function saveAchievements() {
            localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievements));
            renderAchievementsPanel();
        }

        function ensureStats() {
            stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{"gamesCreated":0,"gamesPlayed":0,"avatarsMade":0,"timesVisitedStudio":0}');
            achievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_KEY) || '{}');
            saveStats();
            saveAchievements();
        }

        function loadAvatar() {
            const data = localStorage.getItem(AVATAR_KEY);
            const disp = document.getElementById('display-avatar');
            const dctx = disp.getContext('2d');
            if (data) {
                const img = new Image();
                img.onload = () => dctx.drawImage(img, 0, 0, 64, 64);
                img.src = data;
            } else {
                dctx.fillStyle = '#ffdf7e';
                dctx.fillRect(0,0,64,64);
            }
        }

        window.launchGame = (id) => {
            const g = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}')[id];
            if (!g) return;
            document.getElementById('playing-title').textContent = g.gameTitle;
            document.getElementById('game-frame').src = `data:text/html;charset=utf-8,${encodeURIComponent(g.gameCode)}`;
            document.getElementById('game-frame-container').style.display = 'flex';
            stats.gamesPlayed++; saveStats();
        };

        window.deleteGame = (id) => {
            if(confirm("Are you sure you want to remove this bread?")) {
                const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
                delete games[id];
                localStorage.setItem(PUBLISHED_GAMES_KEY, JSON.stringify(games));
                renderGameList();
            }
        };

        window.getAiFeedback = async (id) => {
            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const g = games[id];
            if (!g) return;
            
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');
            const title = document.getElementById('ai-modal-title');
            
            title.textContent = `‚ú® TaylorTech Game Helper: ${g.gameTitle}`;
            content.innerHTML = '<div class="flex flex-col items-center py-8"><div class="loading-spinner mb-4 border-purple-300 border-t-purple-600"></div><p>Asking TaylorTech for a review...</p></div>';
            modal.style.display = 'flex';

            try {
                const feedback = await callGemini(
                    `Review this game called "${g.gameTitle}" in the category "${g.tag}". Code snippet: ${g.gameCode.substring(0, 500)}...`,
                    "You are a master bread baker and game critic. Give a fun, encouraging review of this game. Use lots of bread puns. Keep it under 100 words."
                );
                content.innerHTML = `<p class="italic text-lg">"${feedback}"</p><div class="mt-4 text-right font-bold">- TaylorTech AI</div>`;
            } catch (err) {
                content.innerHTML = '<p class="text-red-500">Failed to get feedback.</p>';
            }
        };

        window.editGame = (id) => {
            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const game = games[id];
            if (!game) return;

            editingGameId = id;
            document.getElementById('game-title-input').value = game.gameTitle;
            document.getElementById('game-code-input').value = game.gameCode;
            document.getElementById('game-tag-input').value = game.tag || 'Other';
            currentThumbnailDataURL = game.thumbnail;
            
            if (currentThumbnailDataURL) {
                document.getElementById('thumbnail-preview-container').innerHTML = `<img src="${currentThumbnailDataURL}" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('thumbnail-preview-container').innerHTML = 'üçû';
            }

            document.getElementById('publish-game-btn').textContent = "SAVE CHANGES";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('studio-heading').textContent = "üïπÔ∏è Editing: " + game.gameTitle;
            document.getElementById('game-editor-section').scrollIntoView({ behavior: 'smooth' });
        };

        function renderGameList() {
            const listEl = document.getElementById('game-list');
            const noGamesEl = document.getElementById('no-games-message');
            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const ids = Object.keys(games);
            listEl.innerHTML = '';

            const filteredIds = ids.filter(id => {
                const game = games[id];
                const matchesFilter = activeFilter === 'All' || game.tag === activeFilter;
                const matchesSearch = game.gameTitle.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesFilter && matchesSearch;
            });

            if (filteredIds.length === 0) {
                noGamesEl.classList.remove('hidden');
                return;
            }

            noGamesEl.classList.add('hidden');
            filteredIds.forEach(id => {
                const game = games[id];
                const isOwner = game.creatorUsername === userData.username;
                const card = document.createElement('div');
                card.className = "game-card bg-white p-4 rounded-xl shadow-md border group relative";
                card.innerHTML = `
                    <div class="w-full h-24 bg-gray-200 rounded-lg overflow-hidden mb-2 relative">
                        ${game.thumbnail ? `<img src="${game.thumbnail}" class="w-full h-full object-cover">` : '<div class="flex items-center justify-center h-full text-3xl">üçû</div>'}
                        <div class="absolute top-1 right-1">
                            <span class="tag-pill bg-white/90 shadow-sm">${game.tag || 'Other'}</span>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-900 truncate">${game.gameTitle}</h3>
                    <p class="text-[10px] text-gray-400 mb-3 uppercase tracking-tighter">By: ${game.creatorUsername}</p>
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="window.launchGame('${id}')" class="flex-1 bg-green-600 text-white font-bold py-1 px-4 rounded-lg text-sm hover:bg-green-700 transition">Play</button>
                        <button onclick="window.getAiFeedback('${id}')" class="bg-purple-100 text-purple-700 font-bold py-1 px-2 rounded-lg text-sm hover:bg-purple-200" title="AI Review">‚ú®</button>
                        ${isOwner ? `
                            <button onclick="window.editGame('${id}')" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-blue-700 transition">Edit</button>
                            <button onclick="window.deleteGame('${id}')" class="bg-red-500 text-white font-bold py-1 px-2 rounded-lg text-sm hover:bg-red-600 transition">üóëÔ∏è</button>
                        ` : ''}
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        function resetStudio() {
            editingGameId = null;
            document.getElementById('game-title-input').value = '';
            document.getElementById('game-code-input').value = '';
            document.getElementById('game-tag-input').value = 'Other';
            currentThumbnailDataURL = null;
            document.getElementById('thumbnail-preview-container').innerHTML = 'üçû';
            document.getElementById('publish-game-btn').textContent = "PUBLISH LOCALLY";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('studio-heading').textContent = "üïπÔ∏è Bread Game Studio";
        }

        let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0;
        function initCanvas() {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');
            ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            clearCanvas();
            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return [(clientX - rect.left) * (300 / rect.width), (clientY - rect.top) * (300 / rect.height)];
            };
            const startD = (e) => { e.preventDefault(); isDrawing = true; [lastX, lastY] = getCoords(e); };
            const draw = (e) => {
                if (!isDrawing) return; e.preventDefault();
                const [x, y] = getCoords(e);
                ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y);
                ctx.strokeStyle = document.getElementById('color-picker').value;
                ctx.lineWidth = document.getElementById('size-slider').value;
                ctx.stroke(); [lastX, lastY] = [x, y];
            };
            canvas.onmousedown = startD; canvas.onmousemove = draw; window.onmouseup = () => isDrawing = false;
            canvas.ontouchstart = startD; canvas.ontouchmove = draw; canvas.ontouchend = () => isDrawing = false;
        }
        function clearCanvas() { ctx.fillStyle = 'white'; ctx.fillRect(0, 0, 300, 300); }

        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            initCanvas();
            ensureStats();
            renderGameList();

            document.getElementById('magic-bake-btn').onclick = async () => {
                const title = document.getElementById('game-title-input').value.trim();
                const tag = document.getElementById('game-tag-input').value;
                if (!title) {
                    alert("Enter a title first!");
                    return;
                }
                
                const btn = document.getElementById('magic-bake-btn');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner"></div> Processing...';

                try {
                    const generatedCode = await callGemini(
                        `Write a single-file HTML/Javascript game titled "${title}" in the category "${tag}". Use Tailwind CSS for styling if needed. The game must be self-contained and playable.`,
                        "You are an expert game developer. Output ONLY raw HTML/JS code. No markdown formatting, no backticks, just the code."
                    );
                    document.getElementById('game-code-input').value = generatedCode;
                    achievements.magicBakerUsed = true;
                    saveAchievements();
                } catch (err) {
                    alert("TaylorTech encountered an error. Try again.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            };

            document.getElementById('close-ai-modal').onclick = () => {
                document.getElementById('ai-modal').style.display = 'none';
            };

            document.getElementById('search-input').oninput = (e) => {
                searchQuery = e.target.value;
                renderGameList();
            };

            document.getElementById('filter-tag-select').onchange = (e) => {
                activeFilter = e.target.value;
                renderGameList();
            };

            document.getElementById('set-username-btn').onclick = () => {
                const val = document.getElementById('username-input').value.trim();
                if (val) { userData.username = val; saveUserData(); }
            };

            document.getElementById('open-settings-btn').onclick = () => document.getElementById('settings-page').style.display = 'flex';
            document.getElementById('close-settings-btn').onclick = () => document.getElementById('settings-page').style.display = 'none';
            document.getElementById('exit-game-btn').onclick = () => {
                document.getElementById('game-frame-container').style.display = 'none';
                document.getElementById('game-frame').src = '';
            };

            document.getElementById('set-avatar-btn').onclick = () => {
                localStorage.setItem(AVATAR_KEY, canvas.toDataURL());
                loadAvatar();
                stats.avatarsMade++;
                saveStats();
                achievements.firstAvatarDrawn = true;
                saveAchievements();
            };

            document.getElementById('clear-canvas-btn').onclick = clearCanvas;
            document.getElementById('cancel-edit-btn').onclick = resetStudio;
            
            document.getElementById('publish-game-btn').onclick = () => {
                const title = document.getElementById('game-title-input').value.trim();
                const tag = document.getElementById('game-tag-input').value;
                const code = document.getElementById('game-code-input').value.trim();
                if (!title || !code) return;
                const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
                const id = editingGameId || `game-${Date.now()}`;
                games[id] = { 
                    gameTitle: title, 
                    gameCode: code, 
                    creatorUsername: userData.username, 
                    thumbnail: currentThumbnailDataURL, 
                    tag: tag 
                };
                localStorage.setItem(PUBLISHED_GAMES_KEY, JSON.stringify(games));
                if (!editingGameId) {
                    stats.gamesCreated++;
                    achievements.firstGamePublished = true;
                }
                saveStats(); 
                saveAchievements();
                renderGameList();
                resetStudio();
            };

            document.getElementById('use-avatar-thumbnail-btn').onclick = () => {
                currentThumbnailDataURL = canvas.toDataURL();
                document.getElementById('thumbnail-preview-container').innerHTML = `<img src="${currentThumbnailDataURL}" class="w-full h-full object-cover">`;
            };

            document.getElementById('download-game-btn').onclick = () => {
                const title = document.getElementById('game-title-input').value.trim() || 'game';
                const tag = document.getElementById('game-tag-input').value;
                const code = document.getElementById('game-code-input').value.trim();
                const data = { gameTitle: title, gameCode: code, creatorUsername: userData.username, thumbnail: currentThumbnailDataURL, tag: tag };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${title}.bread`;
                a.click();
            };

            document.getElementById('import-game-btn').onclick = () => document.getElementById('import-game-file').click();
            document.getElementById('import-game-file').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.gameTitle && data.gameCode) {
                            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
                            games[`game-${Date.now()}`] = data;
                            localStorage.setItem(PUBLISHED_GAMES_KEY, JSON.stringify(games));
                            renderGameList();
                        }
                    } catch (err) {}
                };
                reader.readAsText(file);
            };

            document.getElementById('thumbnail-upload').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentThumbnailDataURL = ev.target.result;
                    document.getElementById('thumbnail-preview-container').innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            };

            document.getElementById('nuke-data-btn').onclick = () => {
                if(confirm("Wipe all data? This cannot be undone.")) { localStorage.clear(); location.reload(); }
            };
        });
    </script>
</body>
</html>
