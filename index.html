<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bread-Games</title>
    <link rel="icon" type="image/x-icon" href="https://document-export.canva.com/cVnEI/DAG6prcVnEI/4/thumbnail/0001.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAQYCGKMUHWEOTUD6Q%2F20251205%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20251205T163956Z&X-Amz-Expires=23613&X-Amz-Signature=080e917ff154301333b4d4a294fa4ae492513bc1613cfe155af5362980ddf56b&X-Amz-SignedHeaders=host&response-expires=Fri%2C%2005%20Dec%202025%2023%3A13%3A29%20GMT">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        .text-outline {
            text-shadow:
                -0.5px -0.5px 0 #000,
                 0.5px -0.5px 0 #000,
                -0.5px  0.5px 0 #000,
                 0.5px  0.5px 0 #000;
        }
        .text-gold { color: #796833; }
        .text-red-outline {
            text-shadow:
                -0.5px -0.5px 0 #c25252,
                 0.5px -0.5px 0 #c25252,
                -0.5px  0.5px 0 #c25252,
                 0.5px  0.5px 0 #c25252;
            color: #eb1818;
        }
        #game-frame-container {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0,0,0,0.95); z-index:100;
            display: none; flex-direction: column; align-items:center; justify-content:flex-start; overflow-y:auto;
        }
        #game-frame { width:100%; height:100%; border:none; background-color:#fff; }
        .Header { text-align:center; }
        button:disabled { cursor:not-allowed; background-color:#9ca3af !important; }
        #drawing-canvas { touch-action:none; background-color:white; border:4px solid #796833; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.1); }
        .achievement-locked { opacity:0.4; filter:grayscale(0.7); }

        #drag-drop-editor-section {
            display: flex;
            gap: 20px;
            margin-top: 24px;
            padding: 24px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 550px;
            flex-wrap: wrap;
        }
        #palette {
            width: 150px; padding: 10px; background: #f3f3f3;
            border: 2px solid #ccc; border-radius: 6px;
        }
        #palette div {
            padding: 8px; margin: 6px 0; background: #ffe79a;
            border: 1px solid #c9a534; cursor: grab; text-align: center;
            border-radius: 6px;
        }
        #canvas {
            flex: 1; min-height: 400px; border: 3px dashed #aaa;
            position: relative; background: white;
            min-width: 300px;
            overflow: hidden;
        }
        .draggable {
            position: absolute; padding: 10px;
            border: 1px solid #c7a04b;
            cursor: move; border-radius: 6px;
            box-sizing: border-box;
            background-color: transparent;
        }
        .selected { outline: 2px solid dodgerblue; }

        .handle {
            width: 10px; height: 10px; background: dodgerblue;
            position: absolute; right: -5px; bottom: -5px;
            cursor: se-resize; border-radius: 3px;
        }

        #controls {
            width: 200px; padding: 10px; background: #fefefe;
            border: 2px solid #ddd; border-radius: 6px;
        }
        #code-box {
            flex-basis: 100%;
            height: 200px;
            border: 2px solid #888;
            font-family: monospace; padding: 10px; white-space: pre;
            resize: vertical;
            margin-top: 20px;
        }
    </style>
</head>
<body class="bg-[#d3c865] min-h-screen p-4 md:p-8">

    <header class="Header bg-[#f4e1a1] p-6 rounded-xl shadow-2xl mb-8">
        <h1 class="text-5xl font-extrabold text-[#fffff0] text-outline mb-2">Bread-Games</h1>
        <h3 class="text-xl font-semibold text-gold mb-4">Created by Ethan Taylor</h3>
        <a href="https://youtube.com/@cocacolaplayz" class="YT text-lg font-bold text-red-outline transition duration-300 hover:scale-105 inline-block">
            Owner's Social Media
        </a>

        <div id="user-system-container" class="mt-6 p-4 bg-yellow-100 rounded-xl shadow-inner border-2 border-yellow-300 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="col-span-1 flex items-center space-x-4">
                <canvas id="display-avatar" width="64" height="64" class="w-16 h-16 rounded-full border-4 border-yellow-500 bg-white shadow-lg"></canvas>
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1">üçû Player Profile</h2>
                    <p class="text-gray-700 text-lg">User: <span id="display-username" class="font-extrabold text-blue-600">Guest</span></p>
                </div>
            </div>

            <div class="col-span-1 space-y-1">
                <h2 class="text-lg font-bold text-gray-800">Set Display Name</h2>
                <input type="text" id="username-input" placeholder="Enter Username" class="w-full p-2 border border-gray-400 rounded-md text-sm">
                <button id="set-username-btn" class="w-full bg-blue-500 text-white font-semibold py-2 rounded-md hover:bg-blue-600 transition duration-150 text-sm">
                    Update Display Name
                </button>
            </div>

            <div class="col-span-1 space-y-1 p-3 bg-white rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800">üìä Bread Stats</h2>
                <div id="stats-panel" class="text-sm text-gray-700">
                    Loading stats...
                </div>
            </div>

            <div class="col-span-1 space-y-1 p-3 bg-white rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800">üèÜ Achievements</h2>
                <div id="achievements-panel" class="text-sm text-gray-700 space-y-1 mb-3">
                    Loading achievements...
                </div>
                <h2 class="text-lg font-bold text-gray-800 border-t pt-2">üíæ Data Management</h2>
                <button id="download-user-data-btn" class="w-full bg-indigo-500 text-white font-semibold py-2 rounded-md hover:bg-indigo-600 transition duration-150 text-sm">
                    ‚¨áÔ∏è Download All Data (.BreadACC)
                </button>
                <input type="file" id="import-user-data-file" accept=".BreadACC" class="hidden" onchange="importUserData(event)">
                <button id="import-user-data-btn" class="w-full bg-yellow-500 text-gray-800 font-semibold py-2 rounded-md hover:bg-yellow-600 transition duration-150 text-sm">
                    ‚¨ÜÔ∏è Import Data (.BreadACC)
                </button>
            </div>
        </div>

    </header>

    <main class="Content max-w-6xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Available Games (Published)</h2>
        <p id="no-games-message" class="text-lg text-gray-500 hidden mb-4">You haven't published any games yet. Start creating one below!</p>

        <div id="game-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

        <section id="drag-drop-editor-section" class="mt-12 p-6 md:p-10 bg-white rounded-xl shadow-2xl">
            <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center border-b pb-4 w-full">üé® Bread Game Visual Editor</h2>

            <div class="w-full mb-6">
                <label for="game-title-input-dd" class="block text-lg font-semibold text-gray-700 mb-2">Game Title</label>
                <input type="text" id="game-title-input-dd" placeholder="My Awesome Drag-Drop Game" class="w-full p-3 border border-gray-400 rounded-lg text-lg">
            </div>

            <div id="palette">
                <strong>Add Element</strong>
                <div draggable="true" data-type="button">Button</div>
                <div draggable="true" data-type="text">Text</div>
                <div draggable="true" data-type="box">Box</div>
            </div>

            <div id="canvas"></div>

            <div id="controls">
                <h3>Element Controls</h3>
                <label>Color:<br><input type="color" id="color-picker-dd" value="#fff1c7"></label>
                <label class="mt-4 block">Font Family:<br>
                    <select id="font-family-dd" class="w-full p-2 border rounded">
                        <option value="Inter, sans-serif">Inter (Default)</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                    </select>
                </label>
            </div>

            <textarea id="code-box" placeholder="Your game's HTML will appear here. Edit it directly or use the canvas."></textarea>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4 w-full">
                <button id="test-game-dd-btn" class="bg-blue-600 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-xl hover:bg-blue-700 transition duration-150">
                    ‚ñ∂Ô∏è Test Game
                </button>
                <button id="publish-game-dd-btn" class="bg-green-600 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                    ‚¨ÜÔ∏è Publish (Save Locally)
                </button>
                <button id="download-game-dd-btn" class="bg-red-600 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-xl hover:bg-red-700 transition duration-150">
                    ‚¨áÔ∏è Download as .Bread
                </button>
                <button id="load-game-dd-btn" class="bg-yellow-600 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-xl hover:bg-yellow-700 transition duration-150">
                    üîÑ Load From Code Box
                </button>
            </div>
            <p id="studio-status-message" class="text-center font-medium h-4 mt-4 w-full"></p>
        </section>

        <section id="creative-hub-section" class="mt-12 p-6 md:p-10 bg-white rounded-xl shadow-2xl max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center border-b pb-4">üé® Avatar Studio</h2>
            <p class="text-gray-600 mb-6 text-center">Draw your avatar here. This canvas drawing can be referenced in your custom games!</p>

            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/4 space-y-4">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-2">Drawing Tools</h3>

                    <label class="block">
                        <span class="text-sm font-medium text-gray-600">Brush Color:</span>
                        <input type="color" id="color-picker" value="#000000" class="w-full h-10 mt-1 rounded-md cursor-pointer border-2 border-gray-300">
                    </label>

                    <label class="block">
                        <span class="text-sm font-medium text-gray-600">Brush Size (<span id="brush-size-display">5</span>px):</span>
                        <input type="range" id="size-slider" min="1" max="50" value="5" class="w-full mt-1 accent-purple-600">
                    </label>

                    <button id="clear-canvas-btn" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                        üóëÔ∏è Clear Canvas
                    </button>
                </div>

                <div class="w-full md:w-3/4 flex justify-center items-start pt-2">
                    <canvas id="drawing-canvas" width="300" height="300" class="w-full max-w-full aspect-square"></canvas>
                </div>
            </div>

            <div class="mt-8">
                <div class="flex flex-col sm:flex-row justify-center gap-4 mb-4">
                    <button id="set-avatar-btn" class="bg-blue-600 text-white font-bold text-lg py-3 px-8 rounded-lg shadow-xl hover:bg-blue-700 transition duration-150">
                        ‚ú® Set as Profile Avatar
                    </button>
                    <button id="download-art-btn" class="bg-purple-600 text-white font-bold text-lg py-3 px-8 rounded-lg shadow-xl hover:bg-purple-700 transition duration-150">
                        ‚¨áÔ∏è Download Art (PNG)
                    </button>
                </div>
            </div>
        </section>

    </main>

    <div id="game-frame-container">
        <div class="absolute top-4 right-4 z-50">
            <button id="exit-game-btn" class="bg-red-600 text-white font-extrabold text-lg p-3 rounded-full shadow-xl hover:bg-red-700 transition duration-300 transform hover:scale-110">
                &times; Close Game
            </button>
        </div>
        <iframe id="game-frame" allowfullscreen></iframe>
    </div>

    <script>
        const USERNAME_KEY = 'breadgames_username';
        const PUBLISHED_GAMES_KEY = 'breadgames_published_games';
        const AVATAR_KEY = 'breadgames_avatar_data';
        const ACHIEVEMENTS_KEY = 'breadgames_achievements';
        const STATS_KEY = 'breadgames_stats';

        const defaultAchievements = {
            firstGamePublished: false,
            firstAvatarDrawn: false,
            played5Games: false,
            importedBreadFile: false,
            dataImported: false
        };

        const defaultStats = {
            gamesCreated: 0,
            gamesPlayed: 0,
            avatarsMade: 0,
            timesVisitedStudio: 0,
            dateJoined: null
        };

        let userData = { username: 'Guest' };
        let stats = {};
        let achievements = {};
        let currentThumbnailDataURL = null;

        function saveUserData() {
            localStorage.setItem(USERNAME_KEY, userData.username);
            updateDisplay();
        }

        function loadUserData() {
            const savedUsername = localStorage.getItem(USERNAME_KEY);
            if (savedUsername) userData.username = savedUsername;
            updateDisplay();
            loadAvatar();
        }

        function ensureStatsAndAchievements() {
            const savedStats = JSON.parse(localStorage.getItem(STATS_KEY) || 'null');
            const savedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_KEY) || 'null');

            stats = savedStats || Object.assign({}, defaultStats);
            achievements = savedAchievements || Object.assign({}, defaultAchievements);

            if (!stats.dateJoined) {
                stats.dateJoined = new Date().toISOString();
                saveStats();
            }
        }

        function saveStats() {
            localStorage.setItem(STATS_KEY, JSON.stringify(stats));
            renderStatsPanel();
            checkAchievementsAfterStatsChange();
        }

        function saveAchievements() {
            localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievements));
            renderAchievementsPanel();
        }

        function updateDisplay() {
            document.getElementById('display-username').textContent = userData.username;
        }

        function renderStatsPanel() {
            const el = document.getElementById('stats-panel');
            if (!el) return;
            const joined = stats.dateJoined ? new Date(stats.dateJoined).toLocaleDateString() : '‚Äî';
            el.innerHTML = `
                <div>Games Created: <strong>${stats.gamesCreated}</strong></div>
                <div>Games Played: <strong>${stats.gamesPlayed}</strong></div>
                <div>Avatars Drawn: <strong>${stats.avatarsMade}</strong></div>
                <div>Studio Visits: <strong>${stats.timesVisitedStudio}</strong></div>
                <div>Joined On: <strong>${joined}</strong></div>
            `;
        }

        function renderAchievementsPanel() {
            const el = document.getElementById('achievements-panel');
            if (!el) return;
            el.innerHTML = '';

            const list = [
                { key: 'firstGamePublished', label: 'First Game Published' },
                { key: 'firstAvatarDrawn', label: 'First Avatar Drawn' },
                { key: 'played5Games', label: 'Played 5 Games' },
                { key: 'importedBreadFile', label: 'Imported .bread File' },
                { key: 'dataImported', label: 'Restored Account Data' }
            ];

            list.forEach(item => {
                const unlocked = !!achievements[item.key];
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 ${unlocked ? '' : 'achievement-locked'}`;
                div.innerHTML = `
                    <div class="w-6 h-6 flex items-center justify-center rounded-full ${unlocked ? 'bg-yellow-400' : 'bg-gray-300'} text-xs font-bold">
                        ${unlocked ? '‚úì' : '‚úï'}
                    </div>
                    <div>${item.label}</div>
                `;
                el.appendChild(div);
            });
        }

        function unlockAchievement(name) {
            if (!achievements[name]) {
                achievements[name] = true;
                saveAchievements();
                const msgEl = document.getElementById('studio-status-message');
                if (msgEl) {
                    msgEl.classList.remove('text-red-500');
                    msgEl.classList.add('text-green-500');
                    msgEl.textContent = `üèÜ Achievement unlocked: ${name}`;
                    setTimeout(() => msgEl.textContent = '', 3000);
                }
            }
        }

        function checkAchievementsAfterStatsChange() {
            if (stats.gamesCreated > 0) unlockAchievement('firstGamePublished');
            if (stats.avatarsMade > 0) unlockAchievement('firstAvatarDrawn');
            if (stats.gamesPlayed >= 5) unlockAchievement('played5Games');
        }

        function renderGameCard(gameId, gameData) {
            const thumbnailHtml = gameData.thumbnail ? `<img src="${gameData.thumbnail}" class="w-20 h-20 rounded-xl mx-auto mb-4 object-cover">` : `
                <svg class="w-16 h-16 mx-auto text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 10h-2V7h2V5h-2V2h-2v3h-2v2h2v3h-2v2h2v3h2v-3h2v-2h-2v-3zm-6 3v-2h-2V7h2V5h-2V2H9v3H7v2h2v3H7v2h2v3h2v-3zm6-5h-2V7h2v1zM9 5H7V2h2v3zM5 21H3c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h2v14zM3 7v12h2V7H3z"/>
                    <path d="M18 10h2V7h-2V5h-2V2h-2v3h-2v2h2v3h-2v2h2v3h2v-3h2v-2zM7 10h2V7H7v3zM7 5H9V2H7v3zm-4 7h2v-2H3v2zM3 17h2v-2H3v2z"/>
                    <path fill-rule="evenodd" d="M22 19H2V5h20v14zM4 17h16V7H4v10zm11-8V7h2v2h-2zm0 4v-2h2v2h-2zm-4 0v-2h2v2h-2zm-4 0v-2h2v2H7z" clip-rule="evenodd"/>
                </svg>
            `;

            const cardHtml = `
                <div class="game-card bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02]">
                    <div class="mb-4">${thumbnailHtml}</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-1">${escapeHtml(gameData.gameTitle)}</h3>
                    <p class="text-xs font-semibold text-gray-500 mb-2">By: ${escapeHtml(gameData.creatorUsername)}</p>
                    <p class="text-sm text-gray-600 mb-4">A user-created game using local HTML/JS. Play now!</p>
                    <button class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 w-full" onclick="launchGame('${gameId}')">
                        Play Game
                    </button>
                </div>
            `;
            return cardHtml;
        }

        function renderGameList() {
            const gameListEl = document.getElementById('game-list');
            const noGamesEl = document.getElementById('no-games-message');
            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const gameIds = Object.keys(games);

            gameListEl.innerHTML = '';

            if (gameIds.length === 0) {
                noGamesEl.classList.remove('hidden');
                return;
            }

            noGamesEl.classList.add('hidden');

            gameIds.forEach(id => {
                const gameData = games[id];
                gameListEl.insertAdjacentHTML('beforeend', renderGameCard(id, gameData));
            });
        }

        function wrapCodeInHtml(gameCode) {
            return `<!DOCTYPE html>
<html>
<head>
<style>
    body { margin: 0; padding: 0; background: white; overflow: hidden; }
    .draggable { position: absolute; padding: 10px; border-radius: 6px; box-sizing: border-box; }
</style>
</head>
<body>
    <div style="position: relative; width: 100vw; height: 100vh;">
        ${gameCode}
    </div>
</body>
</html>`;
        }

        function publishGameDD() {
            const titleInput = document.getElementById('game-title-input-dd');
            const codeInput = document.getElementById('code-box');
            const messageEl = document.getElementById('studio-status-message');

            const gameTitle = titleInput.value.trim();
            const gameCode = codeInput.value.trim();

            if (!gameTitle || !gameCode) {
                messageEl.classList.remove('text-green-500');
                messageEl.classList.add('text-red-500');
                messageEl.textContent = 'Game Title and Code (from canvas/code box) cannot be empty!';
                setTimeout(() => messageEl.textContent = '', 3000);
                return;
            }

            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const gameId = `game-${Date.now()}`;

            const fullGameHtml = wrapCodeInHtml(gameCode);

            games[gameId] = {
                gameTitle: gameTitle,
                gameCode: fullGameHtml,
                creatorUsername: userData.username,
                publishedDate: new Date().toISOString(),
                thumbnail: null
            };

            localStorage.setItem(PUBLISHED_GAMES_KEY, JSON.stringify(games));

            stats.gamesCreated = (stats.gamesCreated || 0) + 1;
            saveStats();

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = `üéâ Game "${gameTitle}" published successfully!`;
            setTimeout(() => messageEl.textContent = '', 3000);

            renderGameList();
        }

        function testGameDD() {
            const codeInput = document.getElementById('code-box');
            const titleInput = document.getElementById('game-title-input-dd');
            const messageEl = document.getElementById('studio-status-message');

            const gameCode = codeInput.value.trim();
            const gameTitle = titleInput.value.trim() || 'Untitled Game';

            if (!gameCode) {
                messageEl.classList.remove('text-green-500');
                messageEl.classList.add('text-red-500');
                messageEl.textContent = 'Game code cannot be empty to test!';
                setTimeout(() => messageEl.textContent = '', 3000);
                return;
            }

            const fullGameHtml = wrapCodeInHtml(gameCode);
            launchRawCode(fullGameHtml, gameTitle);

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = `‚ñ∂Ô∏è Launching test game: ${gameTitle}`;
            setTimeout(() => messageEl.textContent = '', 3000);
        }

        function downloadGameDD() {
            const titleInput = document.getElementById('game-title-input-dd');
            const codeInput = document.getElementById('code-box');
            const messageEl = document.getElementById('studio-status-message');

            const gameTitle = titleInput.value.trim();
            const gameCode = codeInput.value.trim();

            if (!gameTitle || !gameCode) {
                messageEl.classList.remove('text-green-500');
                messageEl.classList.add('text-red-500');
                messageEl.textContent = 'Game Title and Code cannot be empty for download!';
                setTimeout(() => messageEl.textContent = '', 3000);
                return;
            }

            const breadFileContent = {
                fileType: "BreadGame",
                version: "1.0",
                creatorUsername: userData.username,
                gameTitle: gameTitle,
                gameCode: gameCode,
                thumbnail: null
            };

            const jsonString = JSON.stringify(breadFileContent, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `${gameTitle.replace(/[^a-zA-Z0-9]/g, '_')}.bread`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = `‚¨áÔ∏è Game downloaded as ${link.download}!`;
            setTimeout(() => messageEl.textContent = '', 3000);
        }

        window.importGame = function(event) {
            const file = event.target.files[0];
            const messageEl = document.getElementById('studio-status-message');

            if (!file) return;
            if (!file.name.endsWith('.bread')) {
                messageEl.classList.remove('text-green-500');
                messageEl.classList.add('text-red-500');
                messageEl.textContent = 'Invalid file type. Please select a .bread file.';
                setTimeout(() => messageEl.textContent = '', 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);

                    if (content.fileType !== "BreadGame" || !content.gameTitle || !content.gameCode) {
                        messageEl.classList.remove('text-green-500');
                        messageEl.classList.add('text-red-500');
                        messageEl.textContent = 'Error: Invalid .bread file structure.';
                        return;
                    }

                    document.getElementById('game-title-input-dd').value = content.gameTitle;
                    document.getElementById('code-box').value = content.gameCode;
                    
                    updateCanvasFromCode();

                    unlockAchievement('importedBreadFile');

                    messageEl.classList.remove('text-red-500');
                    messageEl.classList.add('text-green-500');
                    messageEl.textContent = `‚¨ÜÔ∏è Game "${content.gameTitle}" imported! Click 'Publish' to save it locally.`;
                } catch (error) {
                    messageEl.classList.remove('text-green-500');
                    messageEl.classList.add('text-red-500');
                    messageEl.textContent = 'Error parsing .bread file.';
                    console.error("Error parsing .bread file:", error);
                }
                setTimeout(() => messageEl.textContent = '', 5000);
            };
            reader.readAsText(file);
        }

        function downloadUserData() {
            const messageEl = document.getElementById('studio-status-message');
            const dataToExport = {};

            const keysToInclude = [USERNAME_KEY, PUBLISHED_GAMES_KEY, AVATAR_KEY, ACHIEVEMENTS_KEY, STATS_KEY];

            keysToInclude.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    dataToExport[key] = value;
                }
            });

            const accFileContent = {
                fileType: "BreadAccountData",
                version: "1.0",
                exportedDate: new Date().toISOString(),
                localStorageData: dataToExport
            };

            const jsonString = JSON.stringify(accFileContent, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `Bread-Account-Backup-${new Date().toISOString().slice(0, 10)}.BreadACC`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = `‚¨áÔ∏è All user data downloaded as ${link.download}!`;
            setTimeout(() => messageEl.textContent = '', 3000);
        }

        window.importUserData = function(event) {
            const file = event.target.files[0];
            const messageEl = document.getElementById('studio-status-message');

            if (!file) return;
            if (!file.name.endsWith('.BreadACC')) {
                messageEl.classList.remove('text-green-500');
                messageEl.classList.add('text-red-500');
                messageEl.textContent = 'Invalid file type. Please select a .BreadACC file.';
                setTimeout(() => messageEl.textContent = '', 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);

                    if (content.fileType !== "BreadAccountData" || !content.localStorageData) {
                        messageEl.classList.remove('text-green-500');
                        messageEl.classList.add('text-red-500');
                        messageEl.textContent = 'Error: Invalid .BreadACC file structure.';
                        return;
                    }

                    localStorage.clear();

                    const importedData = content.localStorageData;
                    for (const key in importedData) {
                        localStorage.setItem(key, importedData[key]);
                    }

                    loadUserData();
                    ensureStatsAndAchievements();
                    renderStatsPanel();
                    renderAchievementsPanel();
                    renderGameList();
                    unlockAchievement('dataImported');
                    
                    messageEl.classList.remove('text-red-500');
                    messageEl.classList.add('text-green-500');
                    messageEl.textContent = `‚úÖ Successfully imported and restored account data!`;
                } catch (error) {
                    messageEl.classList.remove('text-green-500');
                    messageEl.classList.add('text-red-500');
                    messageEl.textContent = 'Error parsing .BreadACC file. Data was not restored.';
                    console.error("Error parsing .BreadACC file:", error);
                }
                setTimeout(() => messageEl.textContent = '', 5000);
            };
            reader.readAsText(file);
        }

        const CANVAS_SIZE = 300;
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;

        function initializeCanvas() {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');

            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 5;
            ctx.strokeStyle = document.getElementById('color-picker').value;

            clearCanvas(false);

            canvas.addEventListener('mousedown', (e) => startDrawing(e, 'mouse'));
            canvas.addEventListener('mousemove', (e) => draw(e, 'mouse'));
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => startDrawing(e, 'touch'), { passive: false });
            canvas.addEventListener('touchmove', (e) => draw(e, 'touch'), { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            document.getElementById('color-picker').addEventListener('input', (e) => {
                ctx.strokeStyle = e.target.value;
            });

            const sizeSlider = document.getElementById('size-slider');
            const sizeDisplay = document.getElementById('brush-size-display');
            sizeSlider.addEventListener('input', (e) => {
                ctx.lineWidth = e.target.value;
                sizeDisplay.textContent = e.target.value;
            });
        }

        function getClientCoords(e, type) {
            if (type === 'touch' && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            }
            return { clientX: e.clientX, clientY: e.clientY };
        }

        function startDrawing(e, type) {
            e.preventDefault();
            isDrawing = true;
            const { clientX, clientY } = getClientCoords(e, type);
            [lastX, lastY] = getCanvasCoords(clientX, clientY);
            draw(e, type);
        }

        function draw(e, type) {
            if (!isDrawing) return;
            e.preventDefault();

            const { clientX, clientY } = getClientCoords(e, type);
            const [currentX, currentY] = getCanvasCoords(clientX, clientY);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();

            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing() { isDrawing = false; }

        function getCanvasCoords(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            return [x, y];
        }

        function clearCanvas(fillWhite = true) {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function scrollToGameStudio() {
            document.getElementById('drag-drop-editor-section').scrollIntoView({ behavior: 'smooth' });
        }

        function loadAvatar() {
            const avatarData = localStorage.getItem(AVATAR_KEY);
            const displayCanvas = document.getElementById('display-avatar');
            const displayCtx = displayCanvas.getContext('2d');
            const size = displayCanvas.width;

            if (avatarData) {
                const img = new Image();
                img.onload = function() {
                    displayCtx.clearRect(0, 0, size, size);
                    displayCtx.drawImage(img, 0, 0, size, size);
                };
                img.src = avatarData;
            } else {
                displayCtx.clearRect(0, 0, size, size);
                displayCtx.fillStyle = '#ffdf7e';
                displayCtx.beginPath();
                displayCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                displayCtx.fill();
                displayCtx.strokeStyle = '#c27d00';
                displayCtx.lineWidth = 4;
                displayCtx.stroke();
            }
        }

        function setAvatar() {
            const messageEl = document.getElementById('studio-status-message');
            const artDataURL = canvas.toDataURL('image/png');
            localStorage.setItem(AVATAR_KEY, artDataURL);
            loadAvatar();

            stats.avatarsMade = (stats.avatarsMade || 0) + 1;
            saveStats();

            unlockAchievement('firstAvatarDrawn');

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = '‚ú® Avatar updated!';
            setTimeout(() => messageEl.textContent = '', 3000);
        }

        function downloadArt() {
            const messageEl = document.getElementById('studio-status-message');

            const link = document.createElement('a');
            link.download = `bread-asset-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-500');
            messageEl.textContent = `‚úÖ Art asset downloaded as PNG!`;
            setTimeout(() => messageEl.textContent = '', 3000);
        }

        function launchRawCode(fullGameHtml, gameTitle) {
            const gameFrame = document.getElementById('game-frame');
            const gameContainer = document.getElementById('game-frame-container');

            const dataUri = `data:text/html;charset=utf-8,${encodeURIComponent(fullGameHtml)}`;

            gameFrame.src = dataUri;
            gameContainer.style.display = 'flex';

            document.title = gameTitle + ' - Bread-Games';
        }

        function launchGame(gameId) {
            const games = JSON.parse(localStorage.getItem(PUBLISHED_GAMES_KEY) || '{}');
            const gameData = games[gameId];

            if (!gameData || !gameData.gameCode) {
                console.error("Game not found or code is missing:", gameId);
                return;
            }

            launchRawCode(gameData.gameCode, gameData.gameTitle);

            stats.gamesPlayed = (stats.gamesPlayed || 0) + 1;
            saveStats();

            if (stats.gamesPlayed >= 5) unlockAchievement('played5Games');
        }

        function exitGame() {
            const gameFrame = document.getElementById('game-frame');
            const gameContainer = document.getElementById('game-frame-container');

            gameContainer.style.display = 'none';
            gameFrame.src = '';

            document.title = 'Bread-Games';
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        const palette = document.getElementById("palette");
        const canvasDD = document.getElementById("canvas");
        const codeBox = document.getElementById("code-box");
        const colorPickerDD = document.getElementById("color-picker-dd");
        const FONT_FAMILY_DD = document.getElementById("font-family-dd");

        let dragType = null;
        let selected = null;

        if (palette) {
            palette.addEventListener("dragstart", (e) => {
                dragType = e.target.dataset.type;
            });
        }

        if (canvasDD) {
            canvasDD.addEventListener("dragover", (e) => e.preventDefault());
            canvasDD.addEventListener("drop", (e) => {
                if (!dragType) return;
                const el = createElement(dragType, e.offsetX, e.offsetY);
                canvasDD.appendChild(el);
                updateCode();
                dragType = null;
            });
        }

        function createElement(type, x, y) {
            const el = document.createElement("div");
            el.className = "draggable";
            el.style.left = x + "px";
            el.style.top = y + "px";
            el.style.width = "100px";
            el.style.height = "40px";
            el.style.backgroundColor = colorPickerDD.value;
            el.style.fontFamily = FONT_FAMILY_DD.value;
            
            if (type === "button") el.innerHTML = "Button";
            if (type === "text") {
                 el.innerHTML = "Editable Text";
                 el.contentEditable = true;
                 el.style.padding = "4px 8px";
            }
            if (type === "box") el.style.backgroundColor = colorPickerDD.value;

            makeMovable(el);
            addResizeHandle(el);
            enableSelection(el);
            return el;
        }

        function enableSelection(el) {
            el.addEventListener("click", (e) => {
                e.stopPropagation();
                if (selected) selected.classList.remove("selected");
                selected = el;
                el.classList.add("selected");
                
                colorPickerDD.value = rgbToHex(el.style.backgroundColor || window.getComputedStyle(el).backgroundColor);

                const currentFont = el.style.fontFamily || window.getComputedStyle(el).fontFamily;
                let fontValueToSelect = currentFont.replace(/['"]/g, '');

                let matchFound = false;
                for (let i = 0; i < FONT_FAMILY_DD.options.length; i++) {
                    const optionValue = FONT_FAMILY_DD.options[i].value.replace(/['"]/g, '');
                    if (optionValue.toLowerCase().includes(fontValueToSelect.toLowerCase())) {
                         FONT_FAMILY_DD.value = FONT_FAMILY_DD.options[i].value;
                         matchFound = true;
                         break;
                    }
                }
                if (!matchFound) {
                     FONT_FAMILY_DD.value = 'Inter, sans-serif'; 
                }
            });
        }

        document.body.addEventListener("click", () => {
            if (selected) selected.classList.remove("selected");
            selected = null;
        });

        if (colorPickerDD) {
            colorPickerDD.addEventListener("input", () => {
                if (selected) {
                    selected.style.backgroundColor = colorPickerDD.value;
                    updateCode();
                }
            });
        }

        if (FONT_FAMILY_DD) {
            FONT_FAMILY_DD.addEventListener("change", () => {
                if (selected) {
                    selected.style.fontFamily = FONT_FAMILY_DD.value;
                    updateCode();
                }
            });
        }

        function makeMovable(el) {
            let offsetX, offsetY;

            el.addEventListener("mousedown", (e) => {
                if (e.target.classList.contains("handle")) return;
                if (el.contentEditable === "true" && e.target === el) {
                    return;
                }

                offsetX = e.offsetX;
                offsetY = e.offsetY;

                function move(ev) {
                    if (!canvasDD) return;
                    el.style.left = (ev.pageX - canvasDD.offsetLeft - offsetX) + "px";
                    el.style.top = (ev.pageY - canvasDD.offsetTop - offsetY) + "px";
                    updateCode();
                    const rect = canvasDD.getBoundingClientRect();
                    const w = parseInt(getComputedStyle(el).width);
                    const h = parseInt(getComputedStyle(el).height);
                    let left = parseInt(el.style.left);
                    let top = parseInt(el.style.top);
                    if (left < 0) el.style.left = "0px";
                    if (top < 0) el.style.top = "0px";
                    if (left + w > rect.width) el.style.left = (rect.width - w) + "px";
                    if (top + h > rect.height) el.style.top = (rect.height - h) + "px";
                }

                window.addEventListener("mousemove", move);
                window.addEventListener("mouseup", () => {
                    window.removeEventListener("mousemove", move);
                }, { once: true });
            });
        }

        function addResizeHandle(el) {
            el.querySelectorAll('.handle').forEach(h => h.remove());

            const h = document.createElement("div");
            h.className = "handle";
            el.appendChild(h);

            h.addEventListener("mousedown", (e) => {
                e.stopPropagation();
                let startX = e.clientX;
                let startY = e.clientY;
                let startW = parseInt(getComputedStyle(el).width);
                let startH = parseInt(getComputedStyle(el).height);

                function resize(ev) {
                    el.style.width = Math.max(20, startW + (ev.clientX - startX)) + "px";
                    el.style.height = Math.max(20, startH + (ev.clientY - startY)) + "px";
                    updateCode();
                }

                window.addEventListener("mousemove", resize);
                window.addEventListener("mouseup", () => {
                    window.removeEventListener("mousemove", resize);
                }, { once: true });
            });
        }

        function updateCode() {
            if (codeBox) {
                let content = canvasDD.innerHTML;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;

                tempDiv.querySelectorAll('.draggable').forEach(el => {
                    el.classList.remove('selected');
                    el.querySelectorAll('.handle').forEach(h => h.remove());
                    if (el.contentEditable === "true") {
                        el.removeAttribute('contentEditable');
                    }
                });

                codeBox.value = tempDiv.innerHTML;
            }
        }

        function updateCanvasFromCode() {
            if (canvasDD && codeBox) {
                canvasDD.innerHTML = codeBox.value;
                canvasDD.querySelectorAll(".draggable").forEach(el => {
                    makeMovable(el);
                    addResizeHandle(el);
                    enableSelection(el);
                    if (el.textContent === "Editable Text" || el.contentEditable === "true") {
                        el.contentEditable = true;
                    }
                });
            }
        }

        if (codeBox) {
            codeBox.addEventListener("input", updateCanvasFromCode);
        }

        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g).map(x => parseInt(x).toString(16).padStart(2, '0'));
            if (result.length === 3) {
                 return `#${result[0]}${result[1]}${result[2]}`;
            }
            return '#000000';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            initializeCanvas();
            
            if (canvasDD) {
                updateCanvasFromCode();
            }

            ensureStatsAndAchievements();
            stats.timesVisitedStudio = (stats.timesVisitedStudio || 0) + 1;
            saveStats();

            renderStatsPanel();
            renderAchievementsPanel();
            renderGameList();

            document.getElementById('set-username-btn')?.addEventListener('click', () => {
                const input = document.getElementById('username-input');
                const newUsername = input.value.trim();
                const messageEl = document.getElementById('studio-status-message');
                if (newUsername) {
                    userData.username = newUsername;
                    saveUserData();
                    messageEl.classList.remove('text-red-500');
                    messageEl.classList.add('text-green-500');
                    messageEl.textContent = `Display name set to ${newUsername}.`;
                } else {
                    messageEl.classList.remove('text-green-500');
                    messageEl.classList.add('text-red-500');
                    messageEl.textContent = 'Username cannot be empty!';
                }
                setTimeout(() => messageEl.textContent = '', 3000);
                input.value = '';
            });

            document.getElementById('scroll-to-studio-btn')?.addEventListener('click', scrollToGameStudio);
            document.getElementById('exit-game-btn')?.addEventListener('click', exitGame);

            document.getElementById('test-game-dd-btn')?.addEventListener('click', testGameDD);
            document.getElementById('publish-game-dd-btn')?.addEventListener('click', publishGameDD);
            document.getElementById('download-game-dd-btn')?.addEventListener('click', downloadGameDD);
            document.getElementById('load-game-dd-btn')?.addEventListener('click', updateCanvasFromCode);

            document.getElementById('download-user-data-btn')?.addEventListener('click', downloadUserData);
            document.getElementById('import-user-data-btn')?.addEventListener('click', () => {
                document.getElementById('import-user-data-file').click();
            });

            document.getElementById('clear-canvas-btn')?.addEventListener('click', clearCanvas);
            document.getElementById('set-avatar-btn')?.addEventListener('click', setAvatar);
            document.getElementById('download-art-btn')?.addEventListener('click', downloadArt);

            window.launchGame = launchGame;
        });
    </script>
</body>
</html>

